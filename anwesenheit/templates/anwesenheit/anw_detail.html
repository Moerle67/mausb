{% extends "anwesenheit/anw_group.html" %}

{% block content %}
    <script>
        function generate_btn(teilnehmer, anwesend) {
            let btn_color = anwesend ? "success" : "danger";
            let btn_text = anwesend ? "Anwesend" : "Abwesend";
            let btn_code = anwesend ? 2 : 1;
            let str_btn =   "<div class='col-3'>";
            str_btn +=          `<button type="button" class="btn-block btn btn-outline-${btn_color}" onclick="addtermin(${teilnehmer}, ${btn_code})">${btn_text}</button>`;
            str_btn +=      "</div>";
            $('#btn'+ teilnehmer).html(str_btn);
        }
    </script>

    {% for tn in teilnehmer %}
         {% comment %} Keine Einträge für den Tag {% endcomment %}
        <div class="row m-2 border border-1 rounded-pill row">
            <div class = "col-3" onclick="ontn({{tn.0.id}}, '{{tn.0.name}}')">
                {{tn.0.name}} ({{tn.0.profession.short}})
            </div>
            <div class="col-3 row {% if passiv %}d-none{% endif %}" id="btn{{tn.0.id}}">
                <div class = "col">
                    <button type="button" class="btn btn-outline-success"  onclick="addtermin({{tn.0.id}}, 1)">Anwesend</button>
                </div>
                <div class = "col">
                    <button type="button" class="btn btn-outline-danger" onclick="addtermin({{tn.0.id}}, 2)">Abwesend</button>
                </div>
            </div>
            <div class="col">
                <p id="fz{{tn.0.id}}">{{tn.3 | safe}}</p>
            </div> 
        </div>
        <script>
            {% if tn.1 != 0 %}
                generate_btn({{tn.0.id}}, '{{tn.2.0.anwesend}}' == 'True' ? true : false);
            {% endif %}
        </script>    
    {% endfor %}

    <script>
        function ontn(tn_id, tn_name) {
            antwort = prompt(`Anmerkung zu TN: ${tn_name}: `);
            // Abbruch --> antwort = null
            if (antwort != null) {
                $.ajax({
                    type: "POST",
                    url: "{% url 'anw:anw_note' %}",
                    data: {
                        tn: tn_id,
                        note: antwort,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(data) {
                        let answer_str=$('#fz'+tn_id).html()+`<span title="${data['ausbilder']} ${data['time']} - ${data['note']}"><i class="bi bi-envelope me-2"></i>;</span> `;
                        $('#fz'+tn_id).html(answer_str);
                    }
                });
            }
        }
        function addtermin(teilnehmer, code) {
            anwesend = code == 1 ? true : false;
            $.ajax({
                type: "POST",
                url: "{% url 'anw:savedate' %}",
                data: {
                    teilnehmer: teilnehmer,
                    anwesend: anwesend,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(data) {
                    // Button neu generieren
                    generate_btn(teilnehmer, anwesend);

                    // Anwesenheitsliste generieren
                    
                    time = data['time']
                    let color = ""
                    if (code == '1') {
                        color = "text-success"
                    }
                    else {
                        color = "text-danger"
                    }
                    let icon = code == '1' ? "hand-thumbs-up-fill" : "ban-fill";   
                    let string = '<span title="'+data['ausbilder']+'"><i class="bi bi-'+ icon +' me-2 ' + color +'"></i>' + time +';</span> '+$('#fz'+teilnehmer).html()
                    $('#fz'+teilnehmer).html(string);
                }
            });
        }
    </script>
{% endblock content %}


