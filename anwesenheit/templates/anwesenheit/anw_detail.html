{% extends "anwesenheit/anw_group.html" %}

{% block content %}
<style>

</style>
    <script>
        function generate_btn(teilnehmer, anwesend) {
            let btn_color = anwesend ? "success" : "danger";
            let btn_text = anwesend ? "Anwesend" : "Abwesend";
            let btn_code = anwesend ? 2 : 1;
            let str_btn =   "<div class='col-3'>";
            str_btn +=          `<button type="button" class="btn-block btn btn-outline-${btn_color}" onclick="addtermin(${teilnehmer}, ${btn_code}, false)">${btn_text}</button>`;
            str_btn +=      "</div>";
            $('#btn'+ teilnehmer).html(str_btn);
        }
    </script>
    <div class="row"> 
        {% comment %} Überschrift mit Gruppenzähler {% endcomment %}
        <div class="col text-center">
            <h2>{{gruppe}}  <span id="count_anw" >{{count_tn_anw}}</span>/{{count_tn}} </h2>
        </div>
        {% comment %} Button Raum {% endcomment %}
        <div class="col">
            <a href="{% url 'anw:anw_raum' group=gruppe.id date=aim_date %}"><button type="button" class="btn btn-outline-dark float-end">Raum</button></a>
        </div>
    </div>
    {% comment %} Liste Teilnehmer {% endcomment %}
    {% for tn in teilnehmer %}
         {% comment %} Keine Einträge für den Tag {% endcomment %}
        <div class="row m-2 border border-2 rounded-pill row border-dark shadow bg-light bg-opacity-75">
            {% comment %} Name und eventuell Bild Teilnehmer {% endcomment %}
            <div class = "col-4 fs-4">
                <a href="/admin/stammdaten/teilnehmer/{{tn.0.id}}/change/" target="__blank"><i class="bi bi-sliders text-body-secondary"></i></a>
                <i class="bi bi-info-circle"></i>
                <span class="hover-title" onclick="ontn({{tn.0.id}}, '{{tn.0.name}}', true)">{{tn.0.name}} ({{tn.0.profession.short}})</span>
                {% if tn.0.picture %}<div class="hover-image bg-opacity-100 shadow"><img class="" src="{{ tn.0.picture.url }}"/></div>{% endif %}
            </div>
            {% comment %} Button Anwesenheit {% endcomment %}
            <div class="col-3 row {% if passiv %}d-none{% endif %}" id="btn{{tn.0.id}}">
                <div class = "col">
                    <button type="button" class="btn btn-outline-success"  onclick="addtermin({{tn.0.id}}, 1, true)">Anwesend</button>
                </div>
                <div class = "col">
                    <button type="button" class="btn btn-outline-danger" onclick="addtermin({{tn.0.id}}, 2, true)">Abwesend</button>
                </div>
            </div>
            <div class="col">
                <p id="fz{{tn.0.id}}">{{tn.3 | safe}}</p>
            </div> 
        </div>
        <script>
            {% if tn.1 != 0 %}
                generate_btn({{tn.0.id}}, '{{tn.2.0.anwesend}}' == 'True' ? true : false);
            {% endif %}
        </script>    
    {% endfor %}

    <script>
        function ontn(tn_id, tn_name) {
            antwort = prompt(`Anmerkung zu TN: ${tn_name}: `);
            // Abbruch --> antwort = null
            if (antwort != null) {
                $.ajax({
                    type: "POST",
                    url: "{% url 'anw:anw_note' %}",
                    data: {
                        tn: tn_id,
                        note: antwort,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function(data) {
                        let answer_str=$('#fz'+tn_id).html()+`<span title="${data['ausbilder']} ${data['time']} - ${data['note']}"><i class="bi bi-envelope me-2"></i>;</span> `;
                        $('#fz'+tn_id).html(answer_str);
                    }
                });
            }
        }
        function addtermin(teilnehmer, code, newtermin) {
            anwesend = code == 1 ? true : false;
            $.ajax({
                type: "POST",
                url: "{% url 'anw:savedate' %}",
                data: {
                    teilnehmer: teilnehmer,
                    anwesend: anwesend,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(data) {
                    // Button neu generieren
                    generate_btn(teilnehmer, anwesend);
                    // Zähler Überschrift hochzählen
                    let counter = parseInt($('#count_anw').text());
                    if (anwesend) {
                        counter++;
                    } else {
                        if (!newtermin) {
                            counter--;
                        }
                    }
                    $('#count_anw').text(counter);
                    // Anwesenheitsliste generieren
                    
                    time = data['time']
                    let color = ""
                    if (code == '1') {
                        color = "text-success"
                    }
                    else {
                        color = "text-danger"
                    }
                    let icon = code == '1' ? "hand-thumbs-up-fill" : "ban-fill";   
                    let string = '<span title="'+data['ausbilder']+'"><i class="bi bi-'+ icon +' me-2 ' + color +'"></i>' + time +';</span> '+$('#fz'+teilnehmer).html()
                    $('#fz'+teilnehmer).html(string);
                }
            });
        }
    </script>
{% endblock content %}


